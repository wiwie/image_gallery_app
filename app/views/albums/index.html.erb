<script id="template-upload" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-upload">
        <td>
            <span class="preview"></span>
        </td>
        <td>
            <p class="name">{%=file.name%}</p>
            <strong class="error text-danger"></strong>
        </td>
        <td>
            <p class="size">Processing...</p>
            <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div>
        </td>
        <td>
            {% if (!i && !o.options.autoUpload) { %}
                <button class="btn btn-primary start" disabled>
                    <i class="glyphicon glyphicon-upload"></i>
                    <span>Start</span>
                </button>
            {% } %}
            {% if (!i) { %}
                <button class="btn btn-warning cancel">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>Cancel</span>
                </button>
            {% } %}
        </td>
    </tr>
{% } %}
</script>
<script type="text/javascript">

$(document).ready(function() {
    var jumped = false;
    <% if params.has_key?(:pid) %>
        $.fancybox($(".fancybox"), {
            prevEffect  : 'none',
            nextEffect  : 'none',
            closeBtn        : true,
            helpers : {
                title   : {
                    type: 'outside'
                },
                thumbs  : {
                    width   : 50,
                    height  : 50
                },
                buttons : {}
            },
            'type' : 'image',
            afterShow: function(bla) {
                if (!jumped) {
                    $.fancybox.jumpto(<%= params[:pid] %>);
                    jumped = true;
                }
            },
            afterLoad: function(current, previous) {
                if (jumped) {
                    window.history.pushState("object or string", "Title", "?pid=" + current.index <% if params.has_key?(:path) %>+ "&path=<%= params[:path] %>"<% end %>);
                }
            }
        });
    <% else %>
        $(".fancybox").fancybox({
            prevEffect  : 'none',
            nextEffect  : 'none',
            closeBtn        : true,
            helpers : {
                title   : {
                    type: 'outside'
                },
                thumbs  : {
                    width   : 50,
                    height  : 50
                },
                buttons : {}
            },
            'type' : 'image',
            afterLoad: function(current, previous) {
                window.history.pushState("object or string", "Title", "?pid=" + current.index <% if params.has_key?(:path) %>+ "&path=<%= params[:path] %>"<% end %>);
            }
        });
    <% end %>

/*
 * jQuery File Upload Plugin JS Example
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

/* global $, window */

$(function () {
    'use strict';

    // Initialize the jQuery File Upload widget:
    $('#fileupload').fileupload({
        // Uncomment the following to send cross-domain cookies:
        //xhrFields: {withCredentials: true},
        url: 'http://<%= Rails.application.config.node_host %>:<%= Rails.application.config.node_port %>/',
        downloadTemplateId: null
    });

    // Enable iframe cross-domain access via redirect option:
    $('#fileupload').fileupload(
        'option',
        'redirect',
        window.location.href.replace(
            /\/[^\/]*$/,
            '/cors/result.html?%s'
        )
    );

    //if (window.location.hostname === 'blueimp.github.io') {
        console.log(window.location.hostname);
    if (window.location.hostname === 'bla') {
        // Demo settings:
        $('#fileupload').fileupload('option', {
            //url: '//jquery-file-upload.appspot.com/',
            url: 'http://<%= Rails.application.config.node_host %>:<%= Rails.application.config.node_port %>/',
            // Enable image resizing, except for Android and Opera,
            // which actually support image resizing, but fail to
            // send Blob objects via XHR requests:
            disableImageResize: /Android(?!.*Chrome)|Opera/
                .test(window.navigator.userAgent),
            maxFileSize: 999000,
            acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i
        });
        // Upload server status check for browsers with CORS support:
        if ($.support.cors) {
            $.ajax({
                //url: '//jquery-file-upload.appspot.com/',
                url: 'http://<%= Rails.application.config.node_host %>:<%= Rails.application.config.node_port %>/',
                type: 'HEAD'
            }).fail(function () {
                $('<div class="alert alert-danger"/>')
                    .text('Upload server currently unavailable - ' +
                            new Date())
                    .appendTo('#fileupload');
            });
        }
    } else {
        // Load existing files:
        $('#fileupload').addClass('fileupload-processing');
        $('#fileupload').bind('fileuploadcompleted', function (e, data) {
            $(data.result.files).each(function(i, f) {
                console.log(f);
            });
        });
        $.ajax({
            // Uncomment the following to send cross-domain cookies:
            //xhrFields: {withCredentials: true},
            url: $('#fileupload').fileupload('option', 'url'),
            dataType: 'json',
            context: $('#fileupload')[0]
        }).always(function () {
            $(this).removeClass('fileupload-processing');
        }).done(function (result) {
            $(this).fileupload('option', 'done')
                .call(this, $.Event('done'), {result: result});
        });
    }

});
});
</script>

<h1>Album /<%= params[:path] %></h1>
<% if params.has_key?(:path) and params[:path] != '' %>
    <% new_path = params[:path].rpartition('/').first %>
    <%= link_to 'zurück (' + new_path + '/)', url_for(:controller => :albums, :action => :index, :path => new_path) %>
<% else %>
    <% new_path = '/' %>
<% end %>
<% if user_signed_in? %>
<p>
<%= link_to "Neues Album", new_album_path(:path => params[:path]) %>
</p>
<!--<form id="fileupload" action="//jquery-file-upload.appspot.com/" method="POST" enctype="multipart/form-data">-->
<form id="fileupload" action="//<%= Rails.application.config.node_host %>:<%= Rails.application.config.node_port %>/" method="POST" enctype="multipart/form-data">
        <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
        <div class="row fileupload-buttonbar">
            <div class="col-lg-7">
                <!-- The fileinput-button span is used to style the file input field as button -->
                <span class="btn btn-success fileinput-button">
                    <i class="glyphicon glyphicon-plus"></i>
                    <span>Bilder auswählen...</span>
                    <input type="file" name="files[]" multiple>
                </span>
                <button type="submit" class="btn btn-primary start">
                    <i class="glyphicon glyphicon-upload"></i>
                    <span>Jetzt Hochladen</span>
                </button>
                <button type="reset" class="btn btn-warning cancel">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>Hochladen Abbrechen</span>
                </button>
                <input type="hidden" name="path" value="<%= params[:path] %>">
                <input type="checkbox" class="toggle">
                <!-- The global file processing state -->
                <span class="fileupload-process"></span>
            </div>
            <!-- The global progress state -->
            <div class="col-lg-5 fileupload-progress fade">
                <!-- The global progress bar -->
                <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar progress-bar-success" style="width:0%;"></div>
                </div>
                <!-- The extended global progress state -->
                <div class="progress-extended">&nbsp;</div>
            </div>
        </div>
        <!-- The table listing the files available for upload/download -->
        <table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>
    </form>
<% end %>
<h2>Unteralben:</h2>
<ul class="list-inline">
<% @folders.each do |folder| %>
    <li><%= link_to folder, url_for(:controller => :albums, :action => :index, :path => File.join(params.has_key?(:path) ? params[:path] : '/', folder)) %></li>
<% end %>
</ul>
<h2>Bilder:</h2>
<% @files.each do |f, dims| %>
<a class="fancybox" rel="gallery1" href="/serve_image?filename=<%= f.to_s %>&width=1024" title="<%= f.to_s %>">
    <img src="/serve_thumbnail?filename=<%= f.to_s %>" alt="" />
</a>
<% end %>
